#!/usr/bin/env bash
set -euo pipefail

# https://coderwall.com/p/jp7d5q/create-a-global-git-commit-hook
# https://digitaldrummerj.me/git-remove-local-merged-branches/

BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
MAIN_BRANCH=$(git config user.branch || true)

# Build regex of allowed branches (exact match)
if [[ -n "$MAIN_BRANCH" ]]; then
  ALLOWED_REGEX="^(master|main|${MAIN_BRANCH})$"
else
  ALLOWED_REGEX="^(master|main)$"
fi

# Only continue if current branch matches exactly
if [[ ! "$BRANCH_NAME" =~ $ALLOWED_REGEX ]]; then
  exit 0
fi

# Build exclusion regex (never delete master, main, or MAIN_BRANCH)
EXCLUDE_PATTERN="^\*|(master|main"
if [[ -n "$MAIN_BRANCH" ]]; then
  EXCLUDE_PATTERN+="|${MAIN_BRANCH}"
fi
EXCLUDE_PATTERN+=")$"

# Delete merged branches except exclusions
git branch --merged | \
    grep -vE "$EXCLUDE_PATTERN" | \
    xargs -n 1 -r git branch -d

