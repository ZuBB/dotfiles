#!/usr/bin/env bash

SRC_FILE=.git/automerge-queue

logfile=$(mktemp)
echo 'we are about to start' >> $logfile

#[ ! -d "$1/.git" ] && echo "Dir is not valid git repo. Exiting" && exit 1;

#command -v git > /dev/null;
#[ "$?" = 127 ] && echo "Git CLI has not been found. Exiting" && exit 1;

#command -v gh > /dev/null;
#[ "$?" = 127 ] && echo "Github CLI has not been found. Exiting" && exit 1;

cd $1

BRANCH=`head -n 1 $SRC_FILE`
#git show-ref -q --heads $BRANCH
#[ $? -ne 0 ] && echo "Nothing to do today..." && exit 0

echo $1 >> $logfile
echo $BRANCH >> $logfile

git checkout `git config user.branch`
git pull --ff-only --no-verify
git checkout $BRANCH
git rebase `git config user.branch` $BRANCH
git commit --amend --no-edit --date=now
git push --force
echo 'before pr create' >> $logfile
gh pr create --fill >> $logfile
echo 'before pr merge' >> $logfile
gh pr merge --admin --merge >> $logfile
echo 'pr merge done' >> $logfile
git push origin --delete $BRANCH;
git checkout `git config user.branch`
git pull --ff-only --prune --no-verify
tmpfile=$(mktemp)
tail -n +2 $SRC_FILE > $tmpfile
cat $tmpfile > $SRC_FILE
echo -e "\n$BRANCH has been successully landed!"

    echo 'all done' > $logfile
    cat $logfile > /tmp/$(date +%s)
