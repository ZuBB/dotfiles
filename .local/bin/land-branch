#!/usr/bin/env bash

SRC_FILE=.git/automerge-queue

if [ ! -d "$1" ]; then
  echo "Directory does not exist. Exiting";
  exit 1;
fi

command -v git > /dev/null;
if [ "$?" = 127 ]; then
  echo "Git CLI has not been found. Exiting";
  exit 1;
fi

command -v gh > /dev/null;
if [ "$?" = 127 ]; then
  echo "Github CLI has not been found. Exiting";
  exit 1;
fi

logfile=$(mktemp)
echo $1 > $logfile
echo $BRANCH > $logfile

# go to directory with repo
cd $1
# get required branch
BRANCH=`head -n 1 $SRC_FILE`

# ...
if [ -z "$BRANCH" ]; then
  echo "Nothing to do today...";
  exit 0;
fi

# switch to it
git checkout $BRANCH
    echo 'checkout done' > $logfile
# update commit time
git commit --amend --no-edit --date=now
    echo 'amend done' > $logfile
# ...
git push --force
    echo 'push done' > $logfile
# create a pull request in github
gh pr create --fill
    echo 'pr create done' > $logfile
# merge it and do a cleanup
gh pr merge --rebase --admin
    echo 'pr merge done' > $logfile
# switch to home branch
git checkout `git config user.branch`
    echo 'co home done' > $logfile
# ...
git push origin --delete $BRANCH;
    echo 'pd done' > $logfile
# ...
git pull --ff-only --prune
    echo 'pl done' > $logfile
# create tmp file
tmpfile=$(mktemp)
    echo 'mktemp done' > $logfile
# drop processed branch from the list of tasks
tail -n +2 $SRC_FILE > $tmpfile
    echo 'tail done' > $logfile
# rewrite content of branches
cat $tmpfile > $SRC_FILE
    echo 'cat done' > $logfile

echo "$BRANCH has been successully landed!"
    echo 'all done' > $logfile
    cat $tmpfile > /tmp/$(date +%s)
