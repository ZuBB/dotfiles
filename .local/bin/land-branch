#!/usr/bin/env bash

SRC_FILE=.git/automerge-queue

if [ ! -d "$1" ]; then
  echo "Directory does not exist. Exiting";
  exit 1;
fi

command -v git > /dev/null;
if [ "$?" = 127 ]; then
  echo "Git CLI has not been found. Exiting";
  exit 1;
fi

command -v gh > /dev/null;
if [ "$?" = 127 ]; then
  echo "Github CLI has not been found. Exiting";
  exit 1;
fi

# go to directory with repo
cd $1
# get required branch
BRANCH=`head -n 1 $SRC_FILE`

# ...
if [ -z "$BRANCH" ]; then
  echo "Nothing to do today...";
  exit 0;
fi

# switch to it
git checkout $BRANCH
# update commit time
git commit --amend --no-edit --date=now
# ...
git push --force
# create a pull request in github
gh pr create --fill
# merge it and do a cleanup
gh pr merge --rebase --admin
# switch to home branch
git checkout `git config user.branch`
# ...
git push origin --delete $BRANCH;
# ...
git pull --ff-only --prune
# create tmp file
tmpfile=$(mktemp)
# drop processed branch from the list of tasks
tail -n +2 $SRC_FILE > $tmpfile
# rewrite content of branches
cat $tmpfile > $SRC_FILE

echo "$BRANCH has been successully landed!"
